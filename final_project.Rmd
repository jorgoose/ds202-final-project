# Data Sources:
- Spotify Data: Kaggle Spotify Countries dataset link: https://www.kaggle.com/datasets/asaniczka/top-spotify-songs-in-73-countries-daily-updated/universal_top_spotify_songs.csv
- GDP Data: IMF Website

# DS 202 Final Project
## Spotify Data by Country Analysis Using R
The goal of this project is to analyze the Spotify data by country, and see if there are any interesting trends or correlations between the data and other data sources. 

For example, we could see if there is a correlation between a country's GDP and the popularity of a certain genre of music in that country.

---

```{r, results='hide', message=FALSE, warning=FALSE}
library(ggplot2) # Used for data visualization
library(readxl) # Used for reading in Excel files
library(dplyr) # Used for data manipulation

# Install and load the countrycode package, which will be used to convert between country codes (why this is needed is explained later in the project)
install.packages("countrycode", repos="https://cran.r-project.org")
library(countrycode)
```

---

## Importing the IMF GDP-by-Country Data
There is data stored in an Excel workbook file titled "imf_data.xls". Below, we will extract the data from the "Data" sheet of the workbook, and store it in a dataframe.

```{r}

# Read in the Excel file with the read_excel() function. The data desired is in the "Data" sheet. The first three rows are info for the user, so we skip them.
#  Column names are in the fourth row, so we set the col_names argument to TRUE.

imf_data <- read_excel("imf_data.xls", sheet = "Data", skip = 3, col_names = TRUE)

# View the first 6 rows of the data
head(imf_data)

```

## Filtering the IMF GDP-by-Country Data from the Excel Workbook
We are aiming to join this GDP data into our Spotify data. We will need to do some data cleaning / preprocessing first.

```{r}
# The only columns we need are the `Country Code` and `2021` columns.
filtered_imf_gdp_data <- imf_data[, c("Country Code", "2021")]

# Next, we can rename the columns to be more descriptive (rename "2021" to "2021 GDP per capita")
colnames(filtered_imf_gdp_data) <- c("Country Code", "2021 GDP per capita")

# Display the first 6 rows of the filtered data
head(filtered_imf_gdp_data)
```

## Combining Extra Metadeta from the IMF Excel Workbook
Within the Excel workbook from the IMF, there is another sheet titled "Metadata - Countries" that contains metadata for each country. We can add this data to the filtered data to provide more context.

```{r}
# Read in the Excel file, this time from the sheet "Metadata - Countries"
imf_metadata <- read_excel("imf_data.xls", sheet = "Metadata - Countries")

# We want to merge the rows of the "Metadata - Countries" into the "filtered_imf_data" dataframe based on the "Country Code" column.
# We can use the left_join() function from the dplyr package to do this.

merged_imf_data <- left_join(filtered_imf_gdp_data, imf_metadata, by = "Country Code")

# Display the first 6 rows of the merged IMF data
head(merged_imf_data)
```


## Pulling in the Spotify Data
Now that the data is gathered and filtered from the original IMF Excel workbook, it should be ready to be joined into the main Spotify data.

The Spotify dataset has been downloaded from Kaggle and added to this project, and is stored in the file "universal_top_spotify_songs.csv". We can read this data into a dataframe using the read.csv() function.

```{r}
# Read in the Spotify data
spotify_data <- read.csv("universal_top_spotify_songs.csv")

# Display the first 6 rows of the Spotify data
head(spotify_data)
```


## Dealing With Inconsistent Country Code Data
There is a discrepency between the two datasets: the IMF dataset uses Alpha-3 ISO codes for countries, while the Spotify dataset uses Alpha-2 ISO codes. We will need to convert the Alpha-3 codes and Alpha-2 codes to the actual country names, and then join the two datasets.

```{r}

# Convert the Alpha-2 codes in the Spotify data `country` column to Alpha-3 codes to match the IMF data in a new dataframe copy of the Spotify data
spotify_data_alpha3 <- spotify_data %>%
  mutate(country = countrycode(country, "iso2c", "iso3c"))

# Display the first 6 unique values in the `country` column of the Spotify data that aren't <NA>
unique(spotify_data_alpha3$country, incomparables = FALSE)
```


## Joining the IMF and Spotify Data
Now that we've converted the country codes in the Spotify (when possible) to match the IMF data, we should be able to join the two datasets.


### Checking for Overlapping Country Codes
First, it's probably a good idea to check that the country codes in the two datasets match up. We can do this by checking for any country codes that are in both datasets:
```{r}

# Show the country codes that overlap between spotify_data_alpha3's `country` column and merged_imf_data's `Country Code` column
intersect(spotify_data_alpha3$country, merged_imf_data$`Country Code`)

```

### Joining the Two Datasets on the Country Code
Based on this output, we should be able to join the two datasets on the `Country Code` in  merged_imf_data and `country` in spotify_data_alpha3.

```{r}
# Code to join the two datasets on the `Country Code` and `country` columns, and store the result in a new dataframe called `joined_data`.
joined_data <- left_join(spotify_data_alpha3, merged_imf_data, by = c("country" = "Country Code"))

# Remove any data where the `country` column is <NA>
cleaned_joined_data <- joined_data[!is.na(joined_data$country), ]

# Show the first 6 rows of the joined data
# head(cleaned_joined_data)

# Display the first 6 rows of the joined data for `country`, `2021 GDP per capita` and `artists` columns to show that the join merged the data correctly
head(cleaned_joined_data[, c("country", "2021 GDP per capita", "artists")])
```




<!-- End of Data Cleaning and Preprocessing -->
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
<!-- Beginning of Data Exploration and Analysis -->

# Data Exploration and Analysis
Now, all of the data is cleaned, and merged into one dataframe. We can now start to explore the data.

EXAMPLE of analyzing data: Most popular song in ZAF by day
  
```{r}
# For the data in each row with `country` equal to "ZAF" with the `daily rank` column equal to 1, show the `name` and `snapshot_date` column
zaf_most_popular_song <- cleaned_joined_data %>%
  filter(country == "ZAF" & daily_rank == 1) %>%
  select(name, snapshot_date)

# Display the first 6 rows of the data
head(zaf_most_popular_song)

# Create a visual that counts how many times each song was the most popular song in ZAF
ggplot(zaf_most_popular_song, aes(x = name)) +
  geom_bar() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(x = "Song Name", y = "Number of Days as Most Popular Song", title = "Most Popular Song in ZAF by Day")
```

# Number of Explicit vs. Non-Explicit Song Appearances by Country

```{r, fig.width=20, fig.height=10}
# Create a new dataframe that counts the number of explicit and non-explicit songs for each country (true or false in is_explicit column). Exlcude entries with country value of <NA>.
explicit_vs_non_explicit <- cleaned_joined_data %>%
  filter(!is.na(country)) %>%
  group_by(country, is_explicit) %>%
  summarise(count = n())

# Display the first 6 rows of the data
head(explicit_vs_non_explicit)

# Create a visual that shows the number of explicit and non-explicit songs for each country
ggplot(explicit_vs_non_explicit, aes(x = country, y = count, fill = is_explicit)) +
  geom_bar(stat = "identity", position = "dodge") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(x = "Country", y = "Number of Songs", title = "Number of Explicit vs. Non-Explicit Songs by Country")

```

This visual is a bit hard to look at, so instead we can create a visual that shows the percentage of explicit songs as a percentage of all songs for each country.

```{r, fig.width=20, fig.height=10}
# We can add a new column that represents the percentage of songs that are explicit for each country
explicit_percent_by_country <- explicit_vs_non_explicit %>%
  group_by(country) %>%
  mutate(percent = count / sum(count) * 100)

# Display the first 6 rows of the data
head(explicit_percent_by_country)

# Create a visual that shows the percentage column value, where the y axis is the percentage of songs that are explicit for each country and the x axis is the country.
# The column that has the country value of "USA" should have it's bar colored red.

ggplot(explicit_percent_by_country, aes(x = country, y = percent, fill = country)) +
  geom_bar(stat = "identity", position = "dodge") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(x = "Country", y = "Percentage of Songs that are Explicit", title = "Percentage of Explicit Songs by Country") +
  scale_fill_manual(values = c("USA" = "darkred"))
```

...and so on and so forth.
